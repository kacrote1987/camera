<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css" type="text/css">
    <link rel="stylesheet" href="v3.11.2/css/ol.css"/>
    <script type="text/javascript" src="v3.11.2/build/ol.js"></script>
    <link rel="stylesheet" href="layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="layuiadmin/style/admin.css" media="all">
    <script src="https://webapi.amap.com/maps?v=2.0&key=da5c5caa1b78cfce183497a36ad4d2df&plugin=AMap.MarkerCluster,AMap.MouseTool"></script>
    <script type="text/javascript" src="https://cache.amap.com/lbs/static/addToolbar.js"></script>
    <title>万像慧治</title>
    <style>
        html, body, #container {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        .amap-info-window{
            width: 150px;
            background: #fff;
            border-radius: 3px;
            padding: 3px 7px;
            box-shadow: 0 2px 6px 0 rgba(114, 124, 245, .5);
            position: relative;
        }
        .amap-info-sharp{
            position: absolute;
            top: 21px;
            bottom: 0;
            left: 50%;
            margin-left: -8px;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid #fff;
        }
        #container {
            width: 100%;
            height: 94%;
        }
        .top-bar {
            width: 100%;
            height: 50px;
            margin: 0;
            display: flex;
        }
        .box-top {
            width: 100%;
            min-width: 1350px;
            background-color: rgba(255, 255, 255, 0.5);
            padding: 20px;
        }
        .top-ui {
            width: 100%;
            min-width: 800px;
            height: 50px;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .top-ui li {
            width: 10%;
            min-width: 50px;
            margin: -5px 50px 0 70px;
            float: left;
            text-align: left;
            display: block;
        }
        .top-ui a {
            color: black;
            text-decoration: none;
        / / 下划线;
        }
        .top-ui a:hover {
            color: white;
        }
        .top-ui img {
            height: 40px;
            margin: 0;
            padding: 0;
            display: inline;
            position: relative;
            top: -10px;
        }
        .input-card {
            width: 25rem;
        }
        .input-card .btn {
            width: 7rem;
            margin-right: .7rem;
        }
        .input-card .btn:last-child {
            margin-right: 0;
        }
        .content-window-card p {
            height: 2rem;
        }
        div.info-top div {
            display: inline-block;
            color: #333333;
            font-size: 14px;
            font-weight: bold;
            line-height: 31px;
            padding: 0 10px;
        }
        div.info-top img {
            position: absolute;
            top: 10px;
            right: 10px;
            transition-duration: 0.25s;
        }
        div.info-top img:hover {
            box-shadow: 0px 0px 5px #000;
        }
        div.info-bottom img {
            position: relative;
            z-index: 104;
        }
        span {
            margin-left: 5px;
            font-size: 11px;
        }
        .info-middle img {
            float: left;
            margin-right: 6px;
        }
        #panel_search {
            position: fixed;
            background-color: white;
            max-height: 90%;
            overflow-y: auto;
            top: 50px;
            left: 0;
            width: 280px;
        }
        #panel_plan {
            position: fixed;
            background-color: white;
            max-height: 90%;
            overflow-y: auto;
            top: 50px;
            left: 0;
            width: 200px;
        }
    </style>
</head>
<body>
<div class="top-bar">
    <div class="box-top">
        <ul class="top-ui">
            <li STYLE="width: 600px">
                功能菜单：
                <a href="#" onclick="show_search()">点位搜索</a> |
                <a href="#" onclick="show_plan()">科学布建</a> |
                可视域 <input type="checkbox" id="zzz" onclick="drawSectorOpen()"> |
                打点 <input type="radio" name='func' value='marker'> |
                <a href="#" id="clear">清除</a> |
                <a href="#" onclick="show_mark()">收藏夹</a> |
                <a href="#" onclick="full_screen()">全屏</a>
            </li>
        </ul>
    </div>
</div>
<div id="container" class="map" tabindex="0"></div>
<div class="info">收藏夹展示</div>
<div id="panel_plan" class="input-card" style='width: 22rem;'>
    <div class="layui-tab">
        <ul class="layui-tab-title">
            <li class="layui-this">需求</li>
            <li>项目</li>
            <li>归档</li>
        </ul>
        <div class="layui-tab-content">
            <div class="input-item">
                <span class="input-item-text" style="width:4rem;">条件</span>
                <input id='input' type="text" value='' >
                <button>搜 索</button>
            </div>
            <div class="layui-tab-item layui-show">
                <div id="test-tree-demo1"></div>
            </div>
            <div class="layui-tab-item">
                <div id="test-tree-demo2"></div>
            </div>
            <div class="layui-tab-item">
                <div id="test-tree-demo3"></div>
            </div>
        </div>
    </div>
</div>
<div id="panel_search" class="input-card" style='width: 22rem;'>
    <div class="layui-tab">
        <ul class="layui-tab-title">
            <li class="layui-this">组织</li>
            <li>标签</li>
            <li>已申请</li>
        </ul>
        <div class="layui-tab-content">
            <div class="input-item">
                <span class="input-item-text" style="width:4rem;">条件</span>
                <input id='point_search' type="text" value='' >
                <button>搜 索</button>
            </div>
            <div class="layui-tab-item layui-show">
                <div id="test-tree-org"></div>
            </div>
            <div class="layui-tab-item">
                <div id="test-tree-tag"></div>
            </div>
            <div class="layui-tab-item">
                <div id="test-tree-applied"></div>
            </div>
        </div>
    </div>
</div>
<script src="//a.amap.com/jsapi_demos/static/china.js"></script>
<script src="http://apps.bdimg.com/libs/jquery/2.0.0/jquery.min.js"></script>
<script src="http://apps.bdimg.com/libs/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="js/map.js"></script>
<script src="js/demo.js"></script>
<script src="layuiadmin/layui/layui.js"></script>
<script type="text/javascript">
    //新建地图容器
    var map = new AMap.Map('container', {
        zoom: 15,
        viewMode:'3D',
        center: [120.089872,30.856878]
    });

    //地图初始化
    var canvas;
    map.on("complete", function () {
        // 创建 AMap.LabelsLayer 图层
        var layer = new AMap.LabelsLayer({
            zoom: 15
        });
        // 将图层添加到地图
        map.add(layer);
        //设置点位图标样式
        var markers = [];
        var icon = {
            type: 'image',
            image: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
            size: [20, 30],
            anchor: 'bottom-center',
        };
        // 批量获取点位数据源
        function getAllPoints() {
            var result = null;
            $.ajax({
                type: "post",
                url: "/camera/lngLat",
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                async: false,
                success: function (detObj) {
                    if (detObj.msg === "success") {
                        result = detObj.data;
                    }
                }
            });
            return result;
        }
        // var positions = getAllPoints();
        // var count = positions.length;
        var positions = [[120.089872,30.856878],[120.090007,30.857244],[120.093914,30.854382]];

        for (var i = 0; i < positions.length; i++) {
            var curPosition = positions[i];
            var curData = {
                position: curPosition,
                icon
            };
            var labelMarker = new AMap.LabelMarker(curData);
            markers.push(labelMarker);
        }
        // 一次性将海量点添加到图层
        layer.add(markers);

        //设置可视域图层
        canvas = document.createElement('canvas');
        customLayer = new AMap.CustomLayer(canvas, {
            zooms: [3, 20],
            alwaysRender: true,//缩放过程中是否重绘，复杂绘制建议设为false
            zIndex: 22,
            opacity: 0.6
        });
        LabelsLayer = new AMap.LabelsLayer(canvas, {
            zooms: [3, 20],
            alwaysRender: true,//缩放过程中是否重绘，复杂绘制建议设为false
            zIndex: 1000,
            opacity: 0.6,
            collision: false
        });
        mouseTool.close(true)//关闭，并清除覆盖物
    });

    //可视域图层渲染
    function drawSector(centerPos, startAngle, includeAngle, radius) {
        //自定义图层添加渲染方法
        var onRender = function () {
            let size = map.getSize();
            let width = size.width;
            let height = size.height;
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
            canvas.width = width;
            canvas.height = height;
            var ctx = canvas.getContext('2d');
            ctx.fillStyle = 'lightgreen';
            ctx.strokeStyle = 'lightgreen';
            ctx.lineWidth = 4;
            for (var i = 0; i < centerPos.length; i++) {
                let pos = map.lngLatToContainer(centerPos[i]);
                //计算实际半径距离在图层上的像素,用于固定扇形半径随缩放变化
                var newLngLat = azimuth_offset(centerPos[i][0], centerPos[i][1], 0, radius);//距离点的坐标
                let newPos = map.lngLatToContainer(newLngLat);
                let radiusCtx = Math.sqrt((pos.x - newPos.x) * (pos.x - newPos.x) + (pos.y - newPos.y) * (pos.y - newPos.y));
                //绘制图形
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
                ctx.arc(pos.x, pos.y, radiusCtx, Math.PI * startAngle / 180, Math.PI * (startAngle + includeAngle) / 180);
                //ctx.lineTo(pos.x, pos.y);
                ctx.closePath();
                ctx.stroke();
                ctx.fill();
            }
        }
        customLayer.render = onRender;// 将自定义的 render 方法挂在自定义图层的 render 属性上
        customLayer.setMap(map);
        customLayer.show();
    }

    // 可视域图层覆盖范围计算
    function azimuth_offset(origin_lon, origin_lat, azimuth, distance) {
        var lonlat = [0.0, 0.0];
        if (azimuth != null && distance > 0) {
            lonlat[0] = origin_lon + distance * Math.sin(azimuth * Math.PI / 180) * 180 / (Math.PI * 6371229 * Math.cos(origin_lat * Math.PI / 180));
            lonlat[1] = origin_lat + distance * Math.cos(azimuth * Math.PI / 180) / (Math.PI * 6371229 / 180);
        } else {
            lonlat[0] = origin_lon;
            lonlat[1] = origin_lat;
        }
        return lonlat;
    }

    // 可视域图层开关设置
    function drawSectorOpen() {
        var checkBox = document.getElementById("zzz");
        if(checkBox.checked === true){
            $.ajax({
                type: "post",
                url: "/camera/lnglatDraw",
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (detObj) {
                    if (detObj.msg === "success") {
                        let ORIGIN_LONGLAT = [];
                        let pos = [];
                        for (var i = 0; i < detObj.data.length; i++) {
                            pos.push(Number(detObj.data[i].cameraLng), Number(detObj.data[i].cameraLat));
                            ORIGIN_LONGLAT.push(pos);
                            pos = [];
                        }
                        drawSector(ORIGIN_LONGLAT, 0, 60, 30);
                    }
                }
            });
        }else{
            drawSector(0, 0, 0, 0);
        }
    }

    // 画图工具类开始
    var mouseTool = new AMap.MouseTool(map);
    //监听draw事件可获取画好的覆盖物
    // var overlays = [];
    // mouseTool.on('draw',function(e){
    //     overlays.push(e.obj);
    //     console.log("draw="+overlays.toString());
    //     //存入需求区域的经纬度
    //     postdata(overlays.toString(), "/camera/areasave", function () {});
    // })
    function draw(type){
        switch(type){
            case 'marker':{
                mouseTool.marker({
                    //同Marker的Option设置
                });
                break;
            }
        }
    }
    var radios = document.getElementsByName('func');
    for(var i=0;i<radios.length;i+=1){
        radios[i].onchange = function(e){
            draw(e.target.value)
        }
    }
    draw('marker')

    document.getElementById('clear').onclick = function(){
        mouseTool.close(true)//关闭，并清除覆盖物
        for(var i=0;i<radios.length;i+=1){
            radios[i].checked = false;
        }
        map.remove(overlays)
        overlays = [];
    }
    // 画图工具类结束

</script>
<script>
    layui.config({
        base: 'layuiadmin/' //静态资源所在路径
    }).extend({
        index: 'lib/index' //主入口模块
    }).use(['index', 'tree', 'form', 'util', 'table', 'laypage', 'layer'], function(){
        var $ = layui.$
            ,table = layui.table
            ,tree = layui.tree
            ,layer = layui.layer
            ,laypage = layui.laypage

            //模拟数--需求
            ,data1 = [{
                title: '公安分局需求'
                ,id: 1
                ,field: 'dept0'
                ,spread: true
                ,children: [{
                    title: '点位名称1'
                    ,id: 2
                    ,field: 'dept2'
                },{
                    title: '点位名称2'
                    ,id: 3
                    ,field: 'dept3'
                },{
                    title: '点位名称3'
                    ,id: 4
                    ,field: 'dept4'
                }]
            },{
                title: '综合执法局需求'
                ,id: 1
                ,field: 'dept0'
                ,spread: true
                ,children: [{
                    title: '点位名称4'
                    ,id: 2
                    ,field: 'dept2'
                },{
                    title: '点位名称5'
                    ,id: 3
                    ,field: 'dept3'
                },{
                    title: '点位名称6'
                    ,id: 4
                    ,field: 'dept4'
                }]
            },{
                title: '应急管理局需求'
                ,id: 1
                ,field: 'dept0'
                ,spread: true
                ,children: [{
                    title: '点位名称7'
                    ,id: 2
                    ,field: 'dept2'
                },{
                    title: '点位名称8'
                    ,id: 3
                    ,field: 'dept3'
                },{
                    title: '点位名称9'
                    ,id: 4
                    ,field: 'dept4'
                }]
            },{
                title: '水利局需求'
                ,id: 1
                ,field: 'dept0'
                ,spread: true
                ,children: [{
                    title: '点位名称10'
                    ,id: 2
                    ,field: 'dept2'
                },{
                    title: '点位名称11'
                    ,id: 3
                    ,field: 'dept3'
                },{
                    title: '点位名称12'
                    ,id: 4
                    ,field: 'dept4'
                }]
            }]

            //模拟数--项目
            ,data2 = [{
                title: '2025年上半年公共视频监控建设计划'
                ,id: 1
                ,field: 'dept0'
                ,spread: true
                ,children: [{
                    title: '公安分局需求'
                    ,id: 2
                    ,field: 'dept2'
                    ,spread: true
                    ,children: [{
                        title: '点位名称1'
                        ,id: 2
                        ,field: 'dept2'
                    },{
                        title: '点位名称2'
                        ,id: 2
                        ,field: 'dept2'
                    },{
                        title: '点位名称3'
                        ,id: 2
                        ,field: 'dept2'
                    }]
                },{
                    title: '综合执法局需求'
                    ,id: 3
                    ,field: 'dept3'
                    ,spread: true
                    ,children: [{
                        title: '点位名称4'
                        ,id: 2
                        ,field: 'dept2'
                    },{
                        title: '点位名称5'
                        ,id: 2
                        ,field: 'dept2'
                    },{
                        title: '点位名称6'
                        ,id: 2
                        ,field: 'dept2'
                    }]
                },{
                    title: '应急管理局需求'
                    ,id: 4
                    ,field: 'dept4'
                },{
                    title: '水利局需求'
                    ,id: 5
                    ,field: 'dept5'
                },{
                    title: '教育局需求'
                    ,id: 6
                    ,field: 'dept6'
                }]
            }]

            //模拟数--归档
            ,data3 = [{
                title: '2025年上半年公共视频监控建设计划'
                ,id: 1
                ,field: 'dept0'
                ,spread: true
                ,children: [{
                    title: '公安分局需求'
                    ,id: 2
                    ,field: 'dept2'
                    ,spread: true
                    ,children: [{
                        title: '点位名称1'
                        ,id: 2
                        ,field: 'dept2'
                    },{
                        title: '点位名称2'
                        ,id: 2
                        ,field: 'dept2'
                    },{
                        title: '点位名称3'
                        ,id: 2
                        ,field: 'dept2'
                    }]
                },{
                    title: '综合执法局需求'
                    ,id: 3
                    ,field: 'dept3'
                    ,spread: true
                    ,children: [{
                        title: '点位名称4'
                        ,id: 2
                        ,field: 'dept2'
                    },{
                        title: '点位名称5'
                        ,id: 2
                        ,field: 'dept2'
                    },{
                        title: '点位名称6'
                        ,id: 2
                        ,field: 'dept2'
                    }]
                },{
                    title: '应急管理局需求'
                    ,id: 4
                    ,field: 'dept4'
                },{
                    title: '水利局需求'
                    ,id: 5
                    ,field: 'dept5'
                },{
                    title: '教育局需求'
                    ,id: 6
                    ,field: 'dept6'
                }]
            }]

            ,org_data = [{
                title: '点位根目录'
                ,id: 1
                ,field: 'dept0'
                ,spread: true
                ,children: [{
                    title: '组织目录1'
                    ,id: 2
                    ,field: 'dept2'
                    ,spread: true

                    ,children: [{
                        title: '点位名称1'
                        ,id: 2
                        ,field: 'dept2'
                    },{
                        title: '点位名称2'
                        ,id: 2
                        ,field: 'dept2'
                    },{
                        title: '点位名称3'
                        ,id: 2
                        ,field: 'dept2'
                    }]
                },{
                    title: '组织目录2'
                    ,id: 3
                    ,field: 'dept3'
                    ,spread: true
                    ,children: [{
                        title: '点位名称4'
                        ,id: 2
                        ,field: 'dept2'
                    },{
                        title: '点位名称5'
                        ,id: 2
                        ,field: 'dept2'
                    },{
                        title: '点位名称6'
                        ,id: 2
                        ,field: 'dept2'
                    }]
                },{
                    title: '组织目录3'
                    ,id: 4
                    ,field: 'dept4'
                },{
                    title: '组织目录4'
                    ,id: 5
                    ,field: 'dept5'
                },{
                    title: '组织目录5'
                    ,id: 6
                    ,field: 'dept6'
                }]
            }]

            ,tag_data = [{
                title: '标签根目录'
                ,id: 1
                ,field: 'dept0'
                ,spread: true
                ,children: [{
                    title: '场景1'
                    ,id: 2
                    ,field: 'dept2'
                    ,spread: true
                    ,children: [{
                        title: '标签1'
                        ,id: 2
                        ,field: 'dept2'
                    },{
                        title: '标签2'
                        ,id: 2
                        ,field: 'dept2'
                    },{
                        title: '标签3'
                        ,id: 2
                        ,field: 'dept2'
                    }]
                },{
                    title: '场景2'
                    ,id: 3
                    ,field: 'dept3'
                    ,spread: true
                    ,children: [{
                        title: '标签4'
                        ,id: 2
                        ,field: 'dept2'
                    },{
                        title: '标签5'
                        ,id: 2
                        ,field: 'dept2'
                    },{
                        title: '标签6'
                        ,id: 2
                        ,field: 'dept2'
                    }]
                },{
                    title: '场景3'
                    ,id: 4
                    ,field: 'dept4'
                },{
                    title: '场景4'
                    ,id: 5
                    ,field: 'dept5'
                },{
                    title: '场景5'
                    ,id: 6
                    ,field: 'dept6'
                }]
            }]

            ,applied_data = [{
                title: '已申请目录'
                ,id: 1
                ,field: 'dept0'
                ,spread: true
                ,children: [{
                    title: '组织目录1'
                    ,id: 2
                    ,field: 'dept2'
                    ,spread: true

                    ,children: [{
                        title: '点位名称1'
                        ,id: 2
                        ,field: 'dept2'
                    },{
                        title: '点位名称2'
                        ,id: 2
                        ,field: 'dept2'
                    },{
                        title: '点位名称3'
                        ,id: 2
                        ,field: 'dept2'
                    }]
                },{
                    title: '组织目录2'
                    ,id: 3
                    ,field: 'dept3'
                    ,spread: true
                    ,children: [{
                        title: '点位名称4'
                        ,id: 2
                        ,field: 'dept2'
                    },{
                        title: '点位名称5'
                        ,id: 2
                        ,field: 'dept2'
                    },{
                        title: '点位名称6'
                        ,id: 2
                        ,field: 'dept2'
                    }]
                },{
                    title: '组织目录3'
                    ,id: 4
                    ,field: 'dept4'
                },{
                    title: '组织目录4'
                    ,id: 5
                    ,field: 'dept5'
                },{
                    title: '组织目录5'
                    ,id: 6
                    ,field: 'dept6'
                }]
            }]

        //仅节点左侧图标控制收缩
        tree.render({
            elem: '#test-tree-demo1'
            ,data: data1
            ,onlyIconControl: true  //是否仅允许节点左侧图标控制展开收缩
            ,click: function(obj){

            }
        });

        tree.render({
            elem: '#test-tree-demo2'
            ,data: data2
            ,onlyIconControl: true  //是否仅允许节点左侧图标控制展开收缩
            ,click: function(obj){

            }
        });

        tree.render({
            elem: '#test-tree-demo3'
            ,data: data3
            ,onlyIconControl: true  //是否仅允许节点左侧图标控制展开收缩
            ,click: function(obj){

            }
        });

        tree.render({
            elem: '#test-tree-org'
            ,data: org_data
            ,onlyIconControl: true  //是否仅允许节点左侧图标控制展开收缩
            ,click: function(obj){
                //鼠标点击列表中的点位时地图自动定位
                var lng = parseFloat('120.093914');
                var lat = parseFloat('30.854382');
                map.setCenter([lng, lat]); // 设置地图中心点为点击的点位
                map.setZoomAndCenter(15, [lng, lat]);
            }
        });

        tree.render({
            elem: '#test-tree-tag'
            ,data: tag_data
            ,onlyIconControl: true  //是否仅允许节点左侧图标控制展开收缩
            ,click: function(obj){

            }
        });

        tree.render({
            elem: '#test-tree-applied'
            ,data: applied_data
            ,onlyIconControl: true  //是否仅允许节点左侧图标控制展开收缩
            ,click: function(obj){

            }
        });

        $('.layui-fluid .layui-btn').on('click', function(){
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });
    })
    function show_search(){
        document.getElementById('panel_search').style.display='block';
        document.getElementById('panel_plan').style.display='none';
    }
    function show_plan(){
        document.getElementById('panel_search').style.display='none';
        document.getElementById('panel_plan').style.display='block';
    }
</script>
</body>
</html>